# 4장 Amazon Virtual Private Cloud

* Amazon VPC 서비스는 EC2의 네트워크 계층
* EC2 인스턴스를 비롯한 여러 AWS 서비스에 네트워크 리소스를 담을 수 있는 가상 네트워크
* 모든 VPC는 기본적으로 다른 모든 네트워크와 격리, 필요에 따라 인터넷이나 다른 VPC등의 다른 네트워크와 연결


## 4-1 VPC CIDR 블록

* 기존의 네트워크와 마찬가지로 VPC는 하나 이상의 연속적 IP 주소 범위로 구성(CIDR블록으로 표시 ex: 0.0.0.0/24)
* VPC 내 인스턴스를 비롯한 리소스에 할당되는 IP 주소는 CIDR 블록으로 결정
    - Ex) 172.16.0.0/16은 172.16.0.0 ~ 172.16.255.255 인 65,636개의 주소 포함 (/뒤의 숫자가 높을수록 제한적, /0~/32)
* VPC를 온프레미스 네트워크나 다른 VPC 등 다른 네트워크에 연결하려면 사용할 VPC CIDR이 다른 네트워크에서 이미 사용하는 주소와 중복되지 않도록 주의
* 기본 CIDR은 변경 불가

### 보조 CIDR 블록

* VPC를 만든 후에도 보조 CIDR 블록을 지정할 수 있음
* 보조 CIDR 블록은 기본 CIDR 주소 범위나 퍼블릭에서 라우팅이 가능한 범위 내에서 생성
* 기본 블록 또는 다른 보조 블록과 겹치지 않게 주의
    - 기본이 172.16.0.0/16일 때, 보조로 172.17.0.0/16은 가능, 192.168.0.0/16은 불가

### IPv6 CIDR 블록

* VPC에 IPv6 CIDR을 할당할 수 있으나, IP 접두사를 지정할 수 있는 기본 CIDR과는 달리 IPv6에서는 CIDR을 지정 불가
* IPv6 VPC CIDR의 접두사 길이는 항상 /56


## 4-2 서브넷

* 서브넷은 VPC 내 논리 컨테이너로서 EC2 인스턴스를 배치하는 장소
* 서브넷을 통해 인스턴스를 서로 격리, 인스턴스 간 트래픽 흐름 제어, 인스턴스를 기능별로 모을 수 있음
* 서브넷은 기존 네트워크의 가상 LAN의 개념과 유사
* 인스턴스는 서브넷 안에 있어야 함
* 서브넷에 인스턴스를 생성하면 다른 서브넷으로 옮길 수 없지만, 인스턴스를 종료하고 다른 서브넷에 새 인스턴스로 만들 수 있음

### 서브넷 CIDR 블록

* 서브넷의 CIDR은 VPC CIDR의 일부이면서 VPC 내에서 고유해야함
    - VPC CIDR 172.16.0.0/16이면 서브넷의 CIDR은 172.16.100.0/24가 될 수 있음
* 한 VPC 내에서 서브넷 CIDR 블록들은 겹칠 수 없고 서브넷에 CIDR을 할당하고 나면 변경 불가
* 여유 공간이 없어 추가 서브넷을 만들 수 없기 때문에 VPC의 CIDR과 서브넷의 CIDR을 동일하게 하지 않음
* 서브넷은 보조 CIDR을 가지고 있지 않고, 기본 VPC와 보조 VPC 둘 중에 한 곳에만 생성 가능

### 가용영역

* 서브넷은 하나의 가용 영역 내에서만 존재 가능
* AWS 리전의 가용 영역들은 서로 프라이빗으로 연결돼 있으며, 한 가용 영역에 장애가 발생하더라도 다른 영역에 장애의 영향이 미치지 않음
* 서로 다른 가용 영역에 서브넷을 하나씩 만든 다음 인스턴스를 각각 서브넷에 분산해서 만들면, 애플리케이션은 복원성을 확보 가능
* 모든 서브넷을 같은 영역에 배치하면 해당 영역에 장애가 발생했을 때 문제가 커짐

￼

### IPv6 CIDR 블록

* VPC에 IPv6 CIDR을 할당하면 해당 VPC 내 서브넷에 IPv6 CIDR을 할당할 수 있음
* IPv6 서브넷의 접두사 길이는 /64로 고정


## 4-3 탄력적 네트워크 인터페이스

* 탄력적 네트워크 인터페이스 Elastic Network Inteface(ENI)를 사용하면 인스턴스가 AWS 서비스, 다른 인스턴스, 온프레미스 서버, 인터넷 등 다른 네트워크 리소스와 통신 가능
* 인스턴스 관리를 위해 그 위에서 작동하는 운영 체제에 연결 가능
* 기본적으로 물리 서버의 네트워크 인터페이스와 같은 기능을 수행
* 모든 인스턴스에는 기본 네트워크 인터페이스(기본 ENI)가 있어야 하며, 이 인터페이스는 하나의 서브넷에만 연결

### 기본 프라이빗 주소와 보조 프라이빗 IP 주소

* 각 인스턴스는 기본 프라이빗 IP 주소를 가지고 있어야 하는데, 그 주소는. 서브넷 CIDR에서 지정한 범위 내 주소여야 함
* 기본 프라이빗 IP 주소는 인스턴스의 기본 ENI에 연결되며 이 주소는 변경 및 삭제할 수 없음
* 기본 ENI에 보조 프라이빗 IP 주소를 할당 가능
* 보조 주소는 ENI가 연결된 서브넷의 주소 내에서 할당
* ENI를 인스턴스에 추가해서 연결 가능, 이 ENI를 다른 서브넷에 둘 수도 있지만, 해당 인스턴스와 같은 가용 영역 내에 있어야 함

### 탄력적 네트워크 인터페이스 연결

* ENI는 인스턴스와 독립적으로 존재 가능한데, 먼저 ENI를 생성하고 나중에 인스턴스에 연결 가능
* ENI의 종료 시 삭제 속성을 비활성화하면 ENI를 삭제하지 않고 인스턴스 종료 가능
* 기존 ENI를 가져와서 기존 인스턴스에 보조 ENI로 연결 가능
* 장애가 있는 인스턴스에서 ENI를 분리해 작동하고 있는 인스턴스에 연결하면 트래픽을 장애 인스턴스에서 정장 인스턴스로 전환 가능


## 4-4 인터넷 게이트웨이

* 인터넷 게이트웨이는 퍼블릭 IP 주소를 할당받은 인스턴스가 인터넷과 연결돼서 인터넷으로부터 요청을 수신하는 기능 제공
* 처음 VPC를 만들면 인터넷 게이트웨이에 직접 연결 필요
* VPC에는 하나의 인터넷 게이트웨이만 연결 가능
* 인터넷 게이트웨이를 여러개 만들어 여러 VPC에 하나씩 연결 가능
* 인터넷 게이트웨이는 인터넷 밴더가 온프레미스에 설치하는 인터넷 라우터와 유사하지만, 라우터와 똑같이 동작하지는 않음
* 인터넷 게이트웨이에는 관리형 IP 주소나 네트워크 인터페이스가 없는 대신, 식별을 위한 AWS 리소스 ID 할당 (igw-로 시작)
* 인터넷 게이트웨이를 대상으로 하는 기본 라우팅을 라우팅 테이블에 만들어야 함


## 4-5 라우팅 테이블

* VPC는 리소스 형태로 가상 라우터를 구성하지 않으며, 소프트웨어 함수 라우팅인 내재된 라우터(암시적 라우터)를 제공
* 사용자는 가상 라우터에서 인터페이스 IP 주소나 동적 라우팅 프로토콜을 구성하지 않음
* 사용자는 내재된 라우터에서 라우팅 테이블만 관리하면 됨
* 각 라우팅 테이블은 하나 이상의 라우팅과 하나 이상의 서브넷 연결로 구성
* 라우팅 테이블은 기본의 라우터와 거의 같은 방식으로 여러 서브넷에 연결
* 모든 서브넷은 라우팅 테이블에 자동으로 연결된다

### 라우팅

* 라우팅은 라우팅 테이블과 연결된 서브넷 내 인스턴스에서 트래픽을 전달하는 방법을 결정
* IP 라우팅은 원본 IP가 아닌 대상 IP 주소를 기반으로 작동
* 라우팅을 만들때 “대상 주소”, “대상”을 제공 필요
* 대상 주소는 CIDR 표기법, 대상에는 인터넷 게이트웨이, ENI 등의 AWS 리소스로 지정해야 함
* 모든 라우팅 테이블에는 각각 다른 서브넷에 있는 인스턴스들이 서로 통신 가능하게 하는 로컬 라우팅이 포함
* 라우팅 테이블에는 같은 VPC에 있는 인스턴스 간에 통신할 수 있게하는 로컬 라우팅이 필수로 포함됨


### 기본 라우팅

* 인스턴스가 인터넷에 액세스하게 하려면 인터넷 게이트웨이를 가리키는 기본 라우팅 생성 필요
* 기본 라우팅에 대상 주소는 인터넷상의 모든 호스트 IP 주소의 접두사인 0.0.0.0/0을 등록
* 인터넷 게이트웨이를 가리키는 기본 라우팅이 있는 라우팅 테이블이 연결된 서브넷을 퍼블릭 서브넷이라 함
* VPC당 내재된 라우터가 하나가 있는데, 내재된 라우터란 실제 개별 리소스가 아닌 IP 라우킹 가능을 추상화한 것
* 각 라우팅 테이블이 내재된 라우터로 여겨도 무방


### 4-6 보안 그룹

* 보안 그룹은 방화벽과 같은 기능을 제공
* 인스턴스의 ENI에서 송수신 되는 트래픽을 허가해서 인스턴스를 오가는 트래픽 제어
* 모든 ENI에는 최소한 하나의 보안 그룹 연결 필요
* 한 ENI에 여러 개의 보안 그룹을 연결 가능하며, 한 보안 그룹을 여러 개의 ENI에 연결도 가능
* 보안 그룹 생성 시 보안 그룹 이름, 설명, 포함될 VPC를 지정
* 보안 그룹 생성 후 인바운드 및 아웃바운드 규칙을 지정
* 규칙 순서에 상관없이 처리

### 인바운드 규칙

* 인바운드 규칙은 연결된 ENI에 허용할 트래픽을 정의
* 인바운드 규칙은 원본(IP 주소 접두사), 프로토콜, 포트 범위 세 가지 필수 요소로 구성
* 보안 그룹은 화이트리스트라고 하는 default-deny 방식으로 허용되지 않은 트래픽은 모두 거부

### 아웃바운드 규칙

* 아웃바운드 규칙은 인스턴스에 연결된 ENI를 통해 송신할 수 있는 트래픽 정의
* 아웃바운드 규칙은 대상 주소, 프로토콜, 포트 범위 세 가지 요소를 포함
* 아웃바운드 규칙의 주목적은 인스턴스가 인터넷 및 기타 AWS리소스에 액세스할 수 있게 하는 것

### 원본과 대상 주소

* 규칙의 원본이나 대상 주소에 CIDR 또는 보안 그룹의 리소스 ID를 지정 가능
* 보안 그룹에 연결된 모든 인스턴스에 규칙이 적용

### 상태 저장 방화벽

* 보안 그룹은 상태 저장 방화벽 역할 수행
* 상태 저장이란 보안 그룹이 트래픽을 한 방향으로 전달되도록 허용할 때 반대 방향의 응답 트래픽을 지능적으로 허용하는 것을 의미

### 기본 보안 그룹

* 각 VPC에는 삭제할 수 없는 기본 보안 그룹이 있음
* 필요하면 규칙 수정 가능
* 사용자 지정 보안 그룹을 만들어 대신 사용 가능


## 4-7 네트워크 액세스 제어 목록

* 네트워크 액세스 제어 목록(Network Access Control List, NACL)은 보안 그룹의 공통점
    - 방화벽 기능을 수행
    - 원본 또는 대상주소 CIDR, 프로토콜, 포트를 기반으로 트래픽을 제어
    - 각 VPC에는 삭제할 수 없는 기본 NACL이 존재
* NACL과 보안 그룹의 차이점
    - NACL은 ENI가 아닌 서브넷에 연결
    - 서브넷과 연결된 NACL은 해당 서브넷과 송수신되는 트래픽 제어
    - 서브넷 내의 인스턴스 간 트래픽 제어에는 NACL은 사용 불가, 보안 그룹 사용 필요
* 서브넷에는 하나의 NACL만 연결 가능
* VPC에 서브넷을 만들면 기본적으로 VPC의 기본 NACL이 서브넷에 연결
* 기본 NACL을 수정 가능, 새 NACL을 만들어 서브넷에 연결도 가능
* 서브넷과 NACL이 같은 VPC에 있다면 하나의 NACL을 여러 서브넷에 연결 가능
* 보안 그룹은 상태저장이지만 NACL은 상태 비저장
* NACL의 상태 비저장 특성 때문에 모든 인바운드와 아웃바운드 트래픽의 허용규칙을 별도로 작성 필요

### 인바운드 규칙

* 인바운드 규칙은 서브넷에 진입할 수 있는 트래픽 정의
* 규칙번호, 프로토콜, 포트 범위, 원본, 동작(허용/거부)의 요소 포함
* NACL규칙은 규칙 번호의 오름차순으로 처리(하기 표에서는 90 - 100순서로 처리)
* 마지막 행은 기본 규칙으로, *로 지정(삭제 변경 불가, 선순위 규칙에서 허용하지 않는 트래픽 거부)

### 아웃바운드 규칙

* 아웃바운드 규칙은 규칙 번호, 프로토콜, 포트 범위, 대상 주소, 동작(허용/거부)의 요소 포함
* 대상 주소를 제외하고는 인바운드 규칙과 동일(대상 주소는 항목명은 다르지만 CIDR로 표기한다는 점은 같다)
* NACL은 상태 비저장이므로 응답 트래픽을 자동으로 허용하지 않음
    - 인바운드 규칙에서 HTTPS트래픽을 허용하면 아웃바운드 규칙에서도 응답 트래픽을 명시적으로 허용 필요
* 인터넷 액세스 차단 등의 서브넷에서 송신하는 트래픽을 제한하는 경우 응답 트래픽을 임시 포트를 통하도록 아웃바운드 규칙 생성 필요
    - 임시 포트는 클라이언트에서 응답 트래픽을 수신 대기하도록 준비된 TCP포트 또는 UDP포트를 말함

### 네트워크 액세스 제어 목록과 보안 그룹을 같이 사용

* 사용자의 부담을 줄이기 위해 보안 그룹과 NACL을 함께 사용 가능
* NACL은 서브넷에 적용되므로 NACL규칙은 보안 그룹 구성 방법과 관계없이 서브넷에서 송수신하는 모든 트래픽에 적용됨
* 보안 그룹과 NACL을 동시에 변경하는것은 피하는게 좋음
    - 문제 발생시 어디에 문제가 있는 지 트러블 슈팅을 하기 어렵기 때문
* 변경은 인터넷이 연결된 상태에서 하는것이 필요


## 4-8 퍼블릭 IP 주소

* 퍼블릭 IP 주소는 퍼블릭 인터넷으로부터 인스턴스에 액세스하는 데 필수 요소
* AWS외부에서 직접 인터넷을 통해 연결하려면 인스턴스에 퍼블릭 IP 주소가 필요
* VPC내의 인스턴스 간에는 프라이빗 IP 주소로 통신하므로 퍼블릭 IP 주소는 필요없음
* 퍼블릭 IP 주소를 자동으로 할당하면 인스턴스를 중지 종료하면 주소가 변경되거나, AWS 유지보수로 변경될 수 있음
* 장기간 IP 주소를 유지해야하면 탄력적 IP 주소의 사용 권장

## 4-9 탄력적 IP 주소

* 탄력적 IP 주소(EIP)는 AWS에서 사용자가 요청하면 계정에 할당되는 퍼블릭 IP 주소
* 계정에 EIP가 할당되면 사용자가 직접 해제하지 않는 한 해당 주소를 독점
* EIP는 인스턴스와 연결되지 않은 상태로 할당
* EIP는 하나의 ENI와 연결돼야 하며, 다른 ENI로 옮겨서 연결 가능


## 4-10 네트워크 주소 변환

* ENI를 퍼블릭 IP 주소와 연결할 때 ENI는 프라이빗 IP 주소를 그대로 유지
* 퍼블릭 IP를 ENI와 연결한다고 해도 ENI가 새로운 주소로 재구성되는 것은 아님
* 인터넷 게이트웨이는 네트워크 주소 변환(Network Address Translation, NAT)이라는 프로세스를 사용해 퍼블릭 IP 주소와 ENI의 프라이빗 IP 주소를 연결


## 4-11 네트워크 주소 변환 장치

* 인터넷 게이트웨이 이외에 네트워크 주소 변환을 수행하는 서비스(NAT 디바이스라 부름)
    - NAT 게이트웨이
    - NAT 인스턴스
* 이 서비스는 인스턴스가 인터넷에 액세스할 수 있게 하면서 인터넷 상의 호스트에서는 인스턴스에 도달하지 못하게도 함
* NAT 디바이스를 사용하면 퍼블릭 IP 주소를 할당하지 않으므로 인터넷상의 호스트가 인스턴스에 직접 액세스 불가
* NAT 디바이스의 인터페이스는 퍼블릭 서브넷에 위치하면서 퍼블릭 IP가 연결
* 여러 인스턴스가 같은 NAT 디바이스를 사용할 수 있으므로 같은 퍼블릭 IP 주소를 공유해서 아웃바운드 연결 가능

### NAT 디바이스를 사용한 라우팅 테이블 구성

* 프라이빗 서브넷의 인스턴스에서 트래픽이 인터넷으로 전송해야하는 경우, 트래픽이 NAT디바이스를 향하도록 경로 설정 필요
* NAT 디바이스에서 트래픽이 인터넷으로 전송돼야 할 경우, 트래픽은 인터넷 게이트웨이로 향하도록 경로 설정 필요

->  NAT 디바이스의 라우팅과 인스턴스의 기본 라우팅은 다르게 구성 필요  
->  복수의 라우팅 테이블을 사용해야 하므로 서브넷도 분리 필요 

￼

### NAT 게이트웨이

* NAT 게이트웨이는 AWS에서 관리하는 NAT 디바이스
* 인터넷 게이트웨이처럼 하나의 NAT 게이트웨이로 어떠한 용량의 요청도 처리 가능
    - 자동으로 확장해서 모든 대역폭 요구에 대응
* NAT 게이트웨이를 생성할 때 EIP도 함께 할당해서 연결 필요
* 퍼블릭 서브넷 한 곳에 배포해서 인터넷에 액세스할 수 있게 해야함
* NAT 게이트웨이를 만든 후에 기본 라우팅을 만들어야 인스턴스의 인터넷 연결 트래픽이 NAT 게이트웨이로 전달
* NAT 게이트웨이를 여러 개 사용할 떄 각각의 NAT 게이트웨이를 대상으로 하는 기본 라우팅을 여러 개 생성 가능
* NAT 게이트웨이는 ENI를 사용하지 않으므로 보안 그룹을 적용 불가지만, 서브넷에 NACL을 적용해서 트래픽 제어 가능

### NAT 인스턴스

* NAT 인스턴스는 사전 구성된 Linux 기반 AMI를 사용하는 일반적인 EC2 인스턴스
* NAT 게이트웨이처럼 작동하지만 NAT 인스턴스는 몇 가지 중요한 다른 점 존재
    - NAT게이트웨이와는 달리 NAT 인스턴스는 대역폭 요구가 증가하더라도 자동 확장을 수행하지 않음
        - 적절한 성능을 갖춘 인스턴스 선택 필요
    - NAT 인스턴스에는 ENI가 있으므로 보안 그룹을 적용해야하고 퍼블릭 IP 주소를 할당 필요
        - NAT 인스턴스 ENI에서 원본/대상 확인을 비활성화 필요
    - NAT 인스턴스는 배스천 호스트로 사용해서 퍼블릭 IP가 없는 인스턴스에 연결 가능(NAT 게이트웨이는 불가)
* 인터넷 연결 트래픽을 NAT 인스턴스로 보내려면 기본 라우팅 생성 필요
* 장애 발생에 탄력성이 필요하다면 NAT 게이트웨이를 사용하는 것을 권장 

## 4-12 VPC 피어링

* VPC 피어링을 구성하면 한 VPC의 인스턴스가 프라이빗 AWS 네트워크를 통해 다른 VPC와 통신하게 할 수 있음
* VPC 피어링을 활성화하려면 두 VPC 사이에 VPC 피어링 연결을 설정 필요
    - VPC 피어링 연결은 두 VPC 사잉의 지점 간 연결
    - 두 VPC 간에는 단 하나의 피어링만 성정 가능
    - 두 VPC의 CIDR 블록은 겹치지 말아야 함
* VPC 피어링 연결은 인스턴스 간 통신만 허용
    - 한 VPC의 인스턴스에서 피어링 된 다른 VPC의 인스턴스에 연결하는 데만 피어링을 사용 가능
    - 인터넷 게이트웨이나 NAT 디바이스는 VPC 피어링으로 공유 불가, Network LB는 예외적으로 공유 가능
* 피어링 연결을 사용하려면 트래픽이 양방향으로 오가도록 두 VPC에 새로운 라우팅을 생성 필요
* 각 라우팅의 대상이 될 접두사는 대상 VPC의 범위 내에 있어야 함
* 각 경로의 대상은 pcx-로 시작하는 피어링 연결 식별자가 돼야 함

