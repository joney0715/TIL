- 성능 추적
  - AWS 리소스가 정상적으로 작동하는지 확인 필요
  - 예상되는 부하를 처리할 수 있는 충분한 성능이 있는지, 혹은 수직 수평 확장을 수행해야 할 필요가 있는지 파악 필요
- 애플리케이션 문제 탐지
  - 애플리케이션 로그의 경고 또는 오류를 통해 잠재적 문제를 미리 알 수 있게 된다
- 보안 문제 탐지
  - 사용자 활동을 추적하고 권한을 감사함으로써 위험을 줄이고 보안 상태를 향상할 수 있다
- 이벤트 로깅
  - 누가, 언제, 무슨 일을 했는지 상세하게 기록하면 문제의 원인, 영향, 범위를 파악하는 데 도움이 됨
- AWS 리소스 인벤토리 유지 관리
  - 리소스, 구성 방법, 리소스 간의 관계와 종속성 등을 이해하면 환경을 변경하고자 할 떄 어떠한 영향이 있을지 파악 가능
  - 리소스 인벤토리를 최신의 상태로 유지함으로써 조직이 규정을 준수하는데 도움이 됨
  - 리소스 구성을 지속적으로 추적하면 과거 특정 시점의 리소스 구성 방법을 기록한 문서를 이용해 감사 요구에 쉽게 대처 가능



- CloudTrail
  - AWS 리소스의 모든 읽기, 쓰기 작업의 상세 로그를 보관
  - 어떤 일이 , 누구에 의해 언제 일어났는지 알 수 있음
- CloudWatch
  - AWS와 비AWS 리소스에서 수치 성능 지표를 수집
  - 리소스의 로그 파일을 쉽게 저장 및 검색 가능
  - 지표가 임곗값을 초과할 때 알림을 전송하거나 특정 작업을 수행하기 위한 경보 알림
- AWS Config
  - AWS 리소스가 구성된 방식이 어떻게 변경됐는지를 추적
  - 리소스가 서로 어떻게 관련돼 있고 과거 어느 시점에 구성됐는지 확인 가능
  - 리소스 구성과 미리 정의해 둔 기중을 비교 가능
  - 규정을 위반하는 리소스가 있을 때는 경보 알림



# 7-1 CloudTrail

- CloudTrail은 AWS 서비스의 읽기, 쓰기 작업을 기록해서 작업 내역, 관련 리소스와 리전, 작업 수행자와 작업 시기 등에 대한 상세한 기록 제공
- API 작업과 비 API 작업을 모두 기록
  - API 작업으로는 인스턴스 시작, S3 버킷 생성, VPC 생성 등
  - 비 API 작업으로는 Management Console 로그인 등
- API 이벤트로는 다른 AWS 서비스에서 수행되는 작업 등이 있고, 이벤트는 형태에 따라 관리 이벤트와 데이터 이벤트로 분류



### 관리 이벤트

- 관리 이벤트는 보안 주체가 AWS 리소스에서 실행하는 작업을 포함
- 제어 플레인 작업(Control Plane Operation)으로도 부름
- 쓰기 전용 및 읽기 전용 이벤트로 분류
- 쓰기 전용 이벤트에는 리소스를 변경하거나 변경 가능한 API 작업이 있음
- 읽기 전용 이벤트에는 리소스를 읽되, 변경은 하지 않는 API 작업이 해당



### 데이터 이벤트

- 대량의 작업이 수행되는 S3의 객체 수준 활동과 Lambda 함수 실행, 두 가지 유형의 데이터 플레인 작업을 추적
- S3 객체 수준 작업일 때 CloudTrail은 읽기 전용 및 쓰기 전용 이벤트를 구별
- GetObject는 읽기 전용 이벤트, DeleteObject 및 PutObject는 쓰기 전용 이벤트



### **이벤트** **기록**

- CloudTrail은 기본적으로 90일간의 관리 이벤트를 기록하고, 조회 및 검색, 다운로드가 가능한 이벤트 기록이라 부르는 데이터베이스에 저장
- 이벤트 기록은 데이터 이벤트를 포함하지 않음
- CloudTrail은 각 리전별로 이벤트 기록을 별도 작성하고 해당 리전에서의 활동만 기록
- IAM과 Route53 등의 글로벌 서비스 이벤트는 모든 리전의 이벤트 기록에 포함



### 추적

- 90일이 경과한 이벤트 기록을 저장하거나 CloudTrail이 기록하는 이벤트 유형을 사용자 정의할 때 추적(Trail)을 만들 수 있음
- 특정 이벤트를 기록하고 지정한 S3 버킷에 CloudTrail 로그 파일을 전달함
- 로그 파일에는 JSON 형식의 로그 항목이 하나 이상 들어 있음
- 로그 항목은 리소스에서 이뤄지는 활동과 관련된 상세 정보 포함
  - eventTime
    - 활동의 날짜와 시간을 세계표준시(UTC)로 나타냄
    - 로그 파일의 로그 항목은 타임스탬프별로 정렬
    - 타임스탬프가 같을 때는 반드시 이벤트 발생 순서대로 정렬되는 것은 아님
  - userIdentity
    - 요정을 시작한 보안 주체의 상세 정보
    - 보안 주체 유형(예 : IAM역할, 사용자), Amazon 리소스 이름(ARN), IAM 사용자 이름이 포함
  - eventSource
    - 서비스의 활동이 이루어진 글로벌 엔드포인트
  - eventName
    - API 작업의 이름
  - awsRegion
    - 리소스가 있는 리전
    - 글로벌 서비스는 항상 us-east-1
  - sourceIPAddress
    - 요청자의 IP 주소



- 추적 생성
  - 단일 리전 또는 모든 리전의 이벤트를 기록하도록 설정 가능
  - 한 리전에서 최대 5개 추적 생성 가능



- 관리 이벤트와 데이터 이벤트 기록
  - 추적을 만들 때 관리 이벤트만 기록, 데이터 이벤트만 기록, 둘 다 기록 선택 가능
  - 관리 이벤트를 기록할 때는 읽기 전용 이벤트 기록, 쓰기 전용 이벤트 기록, 둘 다 기록 선택 가능



### **로그** **파일 무결성 검증**

- CloudTrail은 로그 파일이 생성된 후에 수정 또는 삭제되지 않을 것을 보장
- 로그 파일 무결성 유효성 검증을 활성화하면 CloudTrail이 로그 파일을 S3 버킷에 전달할 때마다 파일의 암호화 해시 계산
- 해시는 로그 파일 자체의 내용에서 파생된 고유한 값
- 로그 파일이 1바이트라도 변경되면 전체 해시가 변경
- CloudTrail은 매시간, 지난 한시간 동안 전달된 모든 로그 파일의 암호화 해시를 포함하는 다이제스트 파일을 생성
  - CloudTrail은 이 파일을 로그 파일이 있는 버킷의 또 다른 폴더에 저장
  - 다이제스트 파일이 포함된 폴더에 별도의 권한을 추가해서 삭제가 불가능하도록 할 수 있음
- CloudTrail은 리전별로 다른 프라이빗 키를 사용해서 다이제스트 파일을 암호화 서명하고 파일의 S3객체 메타 데이터에 서명을 저장
- 각 다이제스트 파일은 이벤트가 없어도 계속 생성되므로, 해시를 확인하면 전달된 로그 유무 확인 가능



## **7-2 CloudWatch**

- CloudWatch는 AWS 내부 및 외부 리소스의 수치 성능 지표를 수집하고, 검색하고 그래프로 만들 수 있는 지표 저장소 역할 수행
- 모든 리소스는 CloudWatch에 CPU사용률, EBS볼륨 읽기/쓰기 IOPS, S3 버킷 크기, DynamoDB 읽기/ 쓰기 용량 단위 사용량 등의 지표를 자동으로 보냄



### **CloudWatch 지표**

- CloudWatch는 지표를 네임 스페이스로 구성
- AWS 서비스에서 나온 지표는 AWS 네임 스페이스에 저장
- AWS / 서비스 형식으로 쉽게 지표를 분류 가능
- 네임 스페이스는 지표의 컨테이너이며 유사한 이름의 다른 지표와 혼동하지 않게 해줌
  - CloudWatch는 RDS의 WriteOps 지표는 AWS/RDS 네임 스페이스에 저장
- 사용자 지정 지표를 통해 사용자 지정 네임 스페이스를 생성 가능



- 지표는 변수로 작동하며 시간 순서별로 모아놓은 데이터 포인트를 포함
- 각 데이터 포인트에는 타임스탬프, 값, 선택적 측정 단위 포함
- 각 지표는 네임 스페이스, 이름으로 고유하게 정의하며 차원을 정의 가능
- 차원은 같은 이름과 네임 스페이스를 가진 지표를 각각 구분하는 이름-값 형태의 페어로 구성



#### 기본 모니터링과 세부 모니터링

- 대부분의 서비스는 기본 모니터링을 지원하고 일부 서비스는 기본 모니터링과 세부 모니터링을 지원
- 기본 모니터링은 5분마다 CloudWatch에 지표를 보냄(EC2는 기본모니터링을, EBS는 gp2 볼륨을 대상으로 기본 모니터링 사용)
- EC2는 1분마다 통계를 수집하지만 5분 동안의 평균 데이터만을 CloudWatch에 보냄
- 세부 모니터링을 사용하는 서비스는 매분 CloudWatch에 지표를 게시
  - EC2, RDS, DynamoDB, ECS, Lambda 등 70개 이상의 서비스가 세부 모니터링을 지원



#### 일반 정밀도 지표와 고정밀도 지표

- AWS 서비스에서 생성된 지표는 1분 이상의 타임스탬프 정밀도를 지님
- CloudWatch는 최대 1초 단위로 사용자 정의 지표를 저장 가능(1분 미만의 정밀도 지표를 고정밀 지표라 부름)
- PutMetricData API를 사용해서 사용자 정의 지표를 자성 가능
  - 최대 2주 전부터 2시간 이후까지 타임스탬프를 지정 가능(지정을 않하면 UTC로 지표를 받은 시간을 기준으로 만듬)



#### 만료

- CloudWatch에서는 지표가 삭제되지 않고 자동으로 만료
- 만료 시점은 정밀도 수준에 따라 달라짐



### 지표 그래프 작성

- CloudWatch를 사용하면 시간 경과에 따라 데이터 포인트를 그래프로 표시해 지표를 시각화 가능

- 일정 기간 데이터 포인트의 통계 분석을 수행하고 결과를 시계열 그래프로 나타냄

  - 합계 : 해당 기간 모든 데이터 포인트의 합계
  - 최소 : 해당 기간 가장 낮은 데이터 포인트
  - 최대 : 해당 기간 가장 높은 데이터 포인트
  - 평균 : 해당 기간 모든 데이터 포인트 평균
  - 샘플 수 : 해당 기간 데이터 포인트 수
  - 백분율 : 지정된 백분율 데이터 포인트로 표시

   

### 지표 수식

- CloudWatch를 사용하면 지표를 이용해서 다양한 수학 함수르 실행하고 새로운 시계열 그래프 제작 가능
- 지표 데이터에 대한 더하기, 빼기, 곱하기, 나누기, 지수를 포함한 산술 함수를 사용해 여러 지표를 하나의 시계열로 결합



## 7-3 CloudWatch Logs

- AWS 와 비AWS 원본에서 로그를 수집해서 저장
- Cloud scape에서 사용자 정의 지표를 검색하고 추출까지 가능
- CloudTrail 로그 수신, 인스턴스에서 애플리케이션 로그 수집, Route 53 DNS 쿼리 기록 등의 기능을 제공



### 로그 스트림과 로그 그룹

- CloudWatch Logs는 로그 이벤트, 즉 애플리케이션이나 AWS 리소스에서의 활동 기록을 저장
- CloudWatch Log가 로그 이벤트를 이해하려면 이벤트에 타임스탬프와 UTF-8으로 인코딩된 이벤트 메시지가 있어야 함



- CloudWatch Log는 같은 원본(애플리케이션, AWS 리소스)에서 나온 로그 이벤트를 로그 스트림에 저장

  - 인스턴스가 여러 개에서 액세스 로그가 생성될 때, 각 인스턴스는 CloudTrail에 별도 스트림으로 해당 로그르 보냄
  - 로그 스트림은 삭제 가능하지만 개별 로그 이벤트는 삭제 불가

  

- CloudWatch는 로그 스트림을 로그 그룹에 포함 가능, 하나의 스트림은 하나의 그룹에만 속함

- 로그 스트림을 효율적으로 관리하려면 유사한 로그 스트림을 같은 로그 그룹에 배치(수의 제한 없음)



### 지표 필터

- 지표 필터로 로그 그룹의 로그로부터 데이터를 추출해서 CloudWatch 지표를 만들 수 있음
  - 로그 파일의 특정 위치에서 문자열의 발생을 추적 가능
- 지표 값은 숫자
- 지표 필터가 특정 문자열과 일치할 때는 지표에 추가 가능
- 지표 필터는 로그 그룹에 적용
- 지표 필터를 만들기 전에 기록된 CloudWatch 로그 이벤트로는 지표 생성 불가



### CloudWatch 에이전트

- CloudWatch 에이전트는 Linux 나 Window 운영 체제를 실행하는 EC2 인스턴스와 온프레미스 서버에서 로그를 수집
- EC2에서 생성하는 지표와 메모리 사용률 같이 기본으로 지원하지 않는 지표를 포함해서 성능 지표를 수집 가능
- 사용자 지정 지표는 에이전트가 생성한 지표이며 사용자 제정 네임 스페이스에 저장



### CloudTrail Logs를 CloudWatch Logs 로 전송

- CloudTrail 을 구성해서 추적 로그를 CloudWatch Logs의 로그 스트림에 보내고, 이를 통해 추적 로그에서 지표를 추출하고 검색 가능
- CloudTrail은 JSON형식의 추적 로그를 생성해서 지정한 S3 버킷에 저장 가능하지만, 검색은 불가
- CloudWatch는 JSON 형식으로 특정 이벤트를 검색 가능
- 사용자가 검색하려는 로그 그룹과 IAM 역할을 지정하면 CloudTrail은 자동으로 역할을 생성하고 로그 그룹에 역할 부여



# 7-4 CloudWatch 경보

- CloudWatch  경보는 단일 지표를 감시하고 일정 기간 동안 해당 지표를 감시하고 일정 기간 동안 행당 지표에 대해 경보를 생성 가능
- 이를 받은 CloudWatch는 메일 알림, 인스턴스 재부팅, Auto Scaling 등의 작업 가능



## 모니터링할 데이터 포인트

- 통계값으로 백분위를 사용할 때
  - 통계적으로 유의미한 데이터 포인트 수가 누적될 때까지 경보가 전송된 데이터 포인트를 무시할지 선택
  - 통계적으로 유의미하기 위해서 백분위를 설정 필요

### 

## 임계값

- 임계값은 모니터링할 데이터 포인트가 특정 기준을 충족하거나 문제가 발생했다는 것을 알려주는 값
- 경보의 트리거 역할



## 경보 상태

- 경보에는 3가지 상태가 있음
  - ALARM : 경보에 대한 데이터 포인트가 일정 시간 동안 지정된 임계값을 초과한 경우
  - OK : 경보에 대한 데이터 포인트가 일정 시간 동안 지정된 임계값 범위에 있는 경우
  - INSUFFICIENT_DATA : 경보에 대한 데이터 포인트가 지정된 임계값을 넘었는지를 결정하기에 충분한 데이터를 확보 못한 경우
- 새로운 경보는 INSUFFICIENT_DATA 상태에서 시작



## 경보에 대한 데이터 포인트와 평가 기간

- 경보에 대한 데이터 포인트에 따라 경보 상태를 변경하는 경우, 데이터 포인트가 임계값을 초과한 뒤 유지되는 기간에 따라 달라짐
- 경보에 대한 데이터 포인트와 같거나 큰 평가 기간을 설정해야 하는 경우
  - 모니터링할 데이터 포인트가 주기적으로 임계값을 넘지만 계속 유지되는 것은 아닐 때 트리거를 해야할 때
- CloudWatch가 연속적은 데이터 포인트 45, 30, 25를 평가한 결과
  - 3개 데이터 포인터 중 2개가 임계값 아래로 떨어지므로 경보는 ALARM 상태로 전환
  - CloudWatch는 경보 상태를 변경하기 전에 3개 데이터 포인트를 평가



## 누락 데이터

- 평가 기간중에 EBS 볼륨을 인스턴스에서 분리하거나 인스턴스를 중지하면 로그 데이터가 누락될 수 있음
- CloudWatch 에서 누락 데이터를 평가하는 방법
  - As missing : 누락 데이터를 마치 발생한 적 없는 것 취급
  - Not Breaching : 누락 데이터 포인트가 임계값을 위반하지 않는 것으로 간주
  - Breaching : 누락 데이터 발생시 임계값으로 위반하는 것으로 간주
  - Ignore : 경보에 대한 데이터 포인트설정에서 지정된 연속적인 데이터 포인트 개수를 수신할 때까지 상태 변경 안 함



## 작업

- 상태 전환시 작업을 수행하도록 경보를 구성할 수 있음
- 경보가 ALARM 상태로 전환될 때, OK 상태로 전환될 때도 CloudWatch가 작업을 수행하게 할 수 있음
- 이 기능은 CPU 사용률이 비정상적으로 높을 때나 정상으로 복구될 때의 알림으로 유용
- 인스턴스를 모니터링하는 경보가 INSUFFICIENT_DATA 상태가 될 때 작업을 트리거 가능
  - Simple Notification Service(SNS)을 이용한 알림
    - SNS는 주제라고 하는 통신 채널 사용
    - 발신자나 게시자가 구독자라고 하는 한 명 이상의 수신자들에서 알람을 보냄
    - 구독자는 프로토콜과 앤드포인트로 구성
    - 프로토콜은 HTTP, HTTPS, SQS, Lambda, 모바일 푸시, 메일, SMS 등을 사용 가능
  - Auto Scaling 작업
    - 간단한 Auto Scaling 정책을 만들어 인스턴스를 추가하거나 제거 가능
    - 경보 작업을 선택하기 전에 먼저 정책 생성
  - EC2 작업
    - 경보 상태에 대한 응답
    - 인스턴스 중지, 종료, 재부팅, 복구할 수 있음
    - 인스턴스의 문제를 확인 가능하며, 인스턴스를 재부팅해서 해결



# 7-5 AWS Config

- AWS Config 는 특정 시점에 AWS 리소스가 어떻게 구성됐는가를 추적
- 리솟스가 서로 어떻게 관련됐는지 보여줄 수 있으므로 한 리소스의 변경이 다른 리소스에 어떤 영향을 주는지 확인 가능
- 리소스를 전체적으로 보여주고 과거 특정 시점에 어떻게 구성됐는지 알려 줌
- 주요 기능
  - 보안
    - 리소스 구성이 변경될 때마다 사용자에게 잠재적인 챔해 위험을 경보
    - 특정 시점에 사용자에게 어떤 권한이 있었는지 확인 가능
  - 쉬운 감사 보고서
    - 어떤 시점의 구성 스냅샷 보고서를 제공
  - 문제 해결
    - 문제가 시작된 시점의 구성을 분석 가능
  - 변경 관리
    - 한 리소스에서 변경이 이뤄질 때 다른 리소스에 어떻게 영향을 줄 수 있는지 확인 가능



## 구성 레코더

- 구성 레코더는 AWS Config의 핵심 기능
- 리소스를 탐색하고 구성 방법을 기록하며 변경 사항을 모니터링하고 시간 경과에 따라 변경 내용을 추적
- 사용자가 구성한 리전의 모든 항목, IAM과 같은 글로벌 서비스 리소스도 모니터링 가능



## 구성 항목

- 구성 레코더는 모니터링하는 각 리소스의 구성 항목을 생성
- 구성 항목에는 특정 시점의 리소스 설정, 리소스 유형, 해당 ARN, 작성 시기 등의 정보와 다른 리소스와의 관계 포함



## 구성 기록

- 구성 항목을 이용해서 지정된 리소스의 구성 항목 모음인 구성 기록을 작성
- 구성 기록에는 작성 시점, 다른 시점의 구성 방법, 삭제된 시점 등 리소스의 세부 정보가 포함

