- 성능 추적
  - AWS 리소스가 정상적으로 작동하는지 확인 필요
  - 예상되는 부하를 처리할 수 있는 충분한 성능이 있는지, 혹은 수직 수평 확장을 수행해야 할 필요가 있는지 파악 필요
- 애플리케이션 문제 탐지
  - 애플리케이션 로그의 경고 또는 오류를 통해 잠재적 문제를 미리 알 수 있게 된다
- 보안 문제 탐지
  - 사용자 활동을 추적하고 권한을 감사함으로써 위험을 줄이고 보안 상태를 향상할 수 있다
- 이벤트 로깅
  - 누가, 언제, 무슨 일을 했는지 상세하게 기록하면 문제의 원인, 영향, 범위를 파악하는 데 도움이 됨
- AWS 리소스 인벤토리 유지 관리
  - 리소스, 구성 방법, 리소스 간의 관계와 종속성 등을 이해하면 환경을 변경하고자 할 떄 어떠한 영향이 있을지 파악 가능
  - 리소스 인벤토리를 최신의 상태로 유지함으로써 조직이 규정을 준수하는데 도움이 됨
  - 리소스 구성을 지속적으로 추적하면 과거 특정 시점의 리소스 구성 방법을 기록한 문서를 이용해 감사 요구에 쉽게 대처 가능



- CloudTrail
  - AWS 리소스의 모든 읽기, 쓰기 작업의 상세 로그를 보관
  - 어떤 일이 , 누구에 의해 언제 일어났는지 알 수 있음
- CloudWatch
  - AWS와 비AWS 리소스에서 수치 성능 지표를 수집
  - 리소스의 로그 파일을 쉽게 저장 및 검색 가능
  - 지표가 임곗값을 초과할 때 알림을 전송하거나 특정 작업을 수행하기 위한 경보 알림
- AWS Config
  - AWS 리소스가 구성된 방식이 어떻게 변경됐는지를 추적
  - 리소스가 서로 어떻게 관련돼 있고 과거 어느 시점에 구성됐는지 확인 가능
  - 리소스 구성과 미리 정의해 둔 기중을 비교 가능
  - 규정을 위반하는 리소스가 있을 때는 경보 알림



# 7-1 CloudTrail

- CloudTrail은 AWS 서비스의 읽기, 쓰기 작업을 기록해서 작업 내역, 관련 리소스와 리전, 작업 수행자와 작업 시기 등에 대한 상세한 기록 제공
- API 작업과 비 API 작업을 모두 기록
  - API 작업으로는 인스턴스 시작, S3 버킷 생성, VPC 생성 등
  - 비 API 작업으로는 Management Console 로그인 등
- API 이벤트로는 다른 AWS 서비스에서 수행되는 작업 등이 있고, 이벤트는 형태에 따라 관리 이벤트와 데이터 이벤트로 분류



### 관리 이벤트

- 관리 이벤트는 보안 주체가 AWS 리소스에서 실행하는 작업을 포함
- 제어 플레인 작업(Control Plane Operation)으로도 부름
- 쓰기 전용 및 읽기 전용 이벤트로 분류
- 쓰기 전용 이벤트에는 리소스를 변경하거나 변경 가능한 API 작업이 있음
- 읽기 전용 이벤트에는 리소스를 읽되, 변경은 하지 않는 API 작업이 해당



### 데이터 이벤트

- 대량의 작업이 수행되는 S3의 객체 수준 활동과 Lambda 함수 실행, 두 가지 유형의 데이터 플레인 작업을 추적
- S3 객체 수준 작업일 때 CloudTrail은 읽기 전용 및 쓰기 전용 이벤트를 구별
- GetObject는 읽기 전용 이벤트, DeleteObject 및 PutObject는 쓰기 전용 이벤트



### **이벤트** **기록**

- CloudTrail은 기본적으로 90일간의 관리 이벤트를 기록하고, 조회 및 검색, 다운로드가 가능한 이벤트 기록이라 부르는 데이터베이스에 저장
- 이벤트 기록은 데이터 이벤트를 포함하지 않음
- CloudTrail은 각 리전별로 이벤트 기록을 별도 작성하고 해당 리전에서의 활동만 기록
- IAM과 Route53 등의 글로벌 서비스 이벤트는 모든 리전의 이벤트 기록에 포함



### 추적

- 90일이 경과한 이벤트 기록을 저장하거나 CloudTrail이 기록하는 이벤트 유형을 사용자 정의할 때 추적(Trail)을 만들 수 있음
- 특정 이벤트를 기록하고 지정한 S3 버킷에 CloudTrail 로그 파일을 전달함
- 로그 파일에는 JSON 형식의 로그 항목이 하나 이상 들어 있음
- 로그 항목은 리소스에서 이뤄지는 활동과 관련된 상세 정보 포함
  - eventTime
    - 활동의 날짜와 시간을 세계표준시(UTC)로 나타냄
    - 로그 파일의 로그 항목은 타임스탬프별로 정렬
    - 타임스탬프가 같을 때는 반드시 이벤트 발생 순서대로 정렬되는 것은 아님
  - userIdentity
    - 요정을 시작한 보안 주체의 상세 정보
    - 보안 주체 유형(예 : IAM역할, 사용자), Amazon 리소스 이름(ARN), IAM 사용자 이름이 포함
  - eventSource
    - 서비스의 활동이 이루어진 글로벌 엔드포인트
  - eventName
    - API 작업의 이름
  - awsRegion
    - 리소스가 있는 리전
    - 글로벌 서비스는 항상 us-east-1
  - sourceIPAddress
    - 요청자의 IP 주소



- 추적 생성
  - 단일 리전 또는 모든 리전의 이벤트를 기록하도록 설정 가능
  - 한 리전에서 최대 5개 추적 생성 가능



- 관리 이벤트와 데이터 이벤트 기록
  - 추적을 만들 때 관리 이벤트만 기록, 데이터 이벤트만 기록, 둘 다 기록 선택 가능
  - 관리 이벤트를 기록할 때는 읽기 전용 이벤트 기록, 쓰기 전용 이벤트 기록, 둘 다 기록 선택 가능



### **로그** **파일 무결성 검증**

- CloudTrail은 로그 파일이 생성된 후에 수정 또는 삭제되지 않을 것을 보장
- 로그 파일 무결성 유효성 검증을 활성화하면 CloudTrail이 로그 파일을 S3 버킷에 전달할 때마다 파일의 암호화 해시 계산
- 해시는 로그 파일 자체의 내용에서 파생된 고유한 값
- 로그 파일이 1바이트라도 변경되면 전체 해시가 변경
- CloudTrail은 매시간, 지난 한시간 동안 전달된 모든 로그 파일의 암호화 해시를 포함하는 다이제스트 파일을 생성
  - CloudTrail은 이 파일을 로그 파일이 있는 버킷의 또 다른 폴더에 저장
  - 다이제스트 파일이 포함된 폴더에 별도의 권한을 추가해서 삭제가 불가능하도록 할 수 있음
- CloudTrail은 리전별로 다른 프라이빗 키를 사용해서 다이제스트 파일을 암호화 서명하고 파일의 S3객체 메타 데이터에 서명을 저장
- 각 다이제스트 파일은 이벤트가 없어도 계속 생성되므로, 해시를 확인하면 전달된 로그 유무 확인 가능