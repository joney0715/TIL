# 2장 Amazon EC2와 EBS

## 2-1 EC2 인스턴스

### 인스턴스 프로비저닝

* EC2 Amazon 머신 이미지 (AMI)
    1. Amazon 빠른시작 AMI
        - 다양한 리눅스 배포판, Window Server, 딥러닝, DB 등의 공통 작업을 수행하기 위한 특수 이미지가 포함
        - 가장 많이 사용되고, 상시 최신 버전, 공식지원

    2. AWS Marketplace AMI
        - AWS Marketplace 에서 제공하는 AMI는 프로덕션(애플리케이션 개발후, 테스트를 마치고 실제 서비스로 배포되기 직전) 환경에서 사용 가능한 공식 이미지
        - 공급업체가 제공 및 지원

    3. 커뮤니티 AMI
        - 100,000개 이상의 이미지 제공
        - 대부분은 특정한 요구에 맞도록 공급업체가 제작 및 관리
        - 카탈로그 검색으로 필요한 SW가 설치된 AMI를 찾을 수 있음

    4. 프라이빗 AMI
        - 사용자가 자체 배포한 인스턴스에서 이미지를 생성해서 저장하면 프라이빗 AMI제작 가능
        - 온디멘드로 인스턴스를 늘려야할 때, 자동확장에 사용가능
        - 이미지를 AMI로 공유가능, AWS VM Import / Export를 사용하여 VM을 로컬 인프라에서 S3으로 전송 가능

* 인스턴스 유형
    * 범용
        - 컴퓨팅 메모리, 네트워크 리소스를 균형있게 제공
        - T2는 EBS 가상 볼륨을 스토리지로 사용
        - T2.micro는 프리티어로 제공, 실험용, 간단한 웹사이트, 다양한 서비스에 사용
        - M5, M4는 주로 중소규모의 데이터 운영에 권장
        - M은 실제 호스트 서버에 물리적으로 연결된 내장 인스턴스 스토리지 드라이브와 함께 제공

    * 컴퓨팅 최적화(C5, C4)
        - 대규모 요청을 받는 웹 서버, 고성능 머신 러닝 워크로드
        - 3.6GHz 프로세서, 고속 네트워크 대역폭

    * 메모리 최적화 (XIe, X1, R5, R4, z1d)
        - 처리량이 많은 데이터베이스, 데이터 분석, 캐싱 작업에 유용
        - 최대 3TB DRAM, SSD제공

    * 가속화된 컴퓨팅 (P3, P2, G3, F1)
        - 고성능 범용 그래픽 처리 장치가 제공
        - 3D 시각화 / 랜더링, 재무분석, 전산 유체 역학과 같은 높은 부하의 워크로드에 권장

    * 스토리지 최적화 (H1, I3, D2)
        - 지연 시간이 짧은 대용량 인스턴스 스토리지 볼륨 사용
        - 최대 16TB 볼륨 크기
        - D2는 저속 HDD를 최대 48TB 제공
        - 이 인스턴스는 분산 파일 시스템과 규모가 큰 데이터 처리 애플리케이션에 유용

* 인스턴스 환경 구성
    * AWS 리전
        - 대다수의 고객 또는 최종 사용자와 물리적으로 근접한 리전에서 EC2를 시작
        - 법적 규제를 받는 데이터를 사용하는 경우, 규정 준수 요구에 맞는 리전에서 EC2 시작
        - 리전마다 서비스의 기능과 특징, 가격이 다름

    * VPC
        - AWS 네트워크 인프라를 쉽게 구성할 수 있음
        - 인스턴스를 다른 인스턴스와 분리 실행 가능
        - 프로젝트 단위나 단계 별로 VPC를 만들어서 사용


    * 테넌시
        - EC2 시작시, 테넌시 모델을 선택
        - 기본 설정은 “공유 테넌시”. 여러 인스턴스가 한 물리 서버에 동시에 가상 머신으로 실행
        - “전용 인스턴스”를 선택하면 조직만을 위한 전용 서버에서 인스턴스가 실행 (다른고객과 리소스 공유 안함)
        - 전용 인스턴스와 전용 호스트는 공유 테넌시를 사용하는 인스턴스 보다 높은 비용이 부과됨


### 인스턴스 동작 구성

* 부트 스트랩
    - 사용자가 데이터를 지정해 인스턴스가 부팅할 때 명령을 실행할 수 있게 함
    - 스크립트 파일을 작성해 인스턴스를 시작할 때 인스턴스 세부정보 구성에서 지정


### 인스턴스 요금

1. 온디맨드 모델
    - 보통 12개울 미만으로 언제든지 시작
    - 시간당 요금으로 지금
    - 필요에 따라 시작하고 중지하여 비용을 관리
    - 가장 유연한 사용방법
    - 다른 모델과 비교하면 시간당 요금이 비쌈

2. 예약 인스턴스
    - 1년 또는 3년 기간 약정
    - 요금을 선결제 하거나, 일부를 선결제하고 나머지는 월 별로 지금, 혹은 전체 요금을 월별로 나누어서 지급

3. 스팟 인스턴스
    - 갑자기 중단 되어도 피해가 크지 않은 워크로드에 사용
    - Amazon 스팟 시장에서 구매 가능
    - 특정 리전에서 실행되는 인스턴스에 대해 사용자가 최대 입찰 요금을 입력해서 인스턴스를 사용
    - 시간당 요금이 사용자가 입찰한 요금이라면 미리 지정한 AMI 및 템플릿으로 인스턴스 시작
    - 사용자가 중지하거나 시간당 요금이 입찰가 보다 비싸지면 인스턴스 중지 (비용 최적화)

-> 여러 모델을 섞어서 이용가능 (예를 들어, 평상시는 예약 인스턴스, 트래픽 증가시 Auto Scaling으로 온디맨드 인스턴스)


### 인스턴스 수명 주기

* 인스턴스를 사용하지 않을 때는 중지 함으로서 비용절감 가능
* 인스턴스 스토어 볼륨의 데이터는 삭제되지만, EBS볼륨에 저장된 데이터는 삭제되지 않는다
* 인스턴스를 재시작하면 임시 퍼블릭 IP주소는 바뀜, 탄력적 IP를 사용하면 바뀌지 않음
* 인스턴스가 실행되는 동안 보안 그룹이나 액세스 정책 변경 가능


### 리소스 태그

* 계정에 리소스를 많이 배포할수록 리소스를 추적하기 어려워짐
* 리소스를 빠르게 식별할 수 있도록, 명명 규칙에 따라 태그를 붙일 수 있음
* AWS의 모든 리소스에 태그를 붙일 수 있으며, 하나의 태그는 키와 값으로 구성된다 (표시예, production-server1, production-server2)
* 리소스의 가시성을 높이고, 리소스를 더 쉽고 효과적으로 관리 가능


### 서비스 할당량

* AWS의 리소스 할당량은 제한되어 있음. 할당량을 올리기 원하면 AWS에 요청 필요
* VPC는 5개, 키페어는 5000개 등



## 2-2 EC2 스토리지 볼륨

스토리지 드라이브, 볼륨은 물리 드라이브를 가상으로 나눈 공간, 운영 체제에서는 실제 물리 드라이브처럼 보임

### Elastic Block Store 볼륨 (EBS)

* EBS는 필요한 수만큼 인스턴스에 연결할 수있으며, 하드 드라이브, 플래시 드라이브와 유사하게 사용
* SLA에서 99.999%의 가용성으로 EBS볼륨에 저장한 데이터의 안정성을 보장
* EBS 볼륨 유형에는 SSD를 사용하는 2가지 유형과 HDD를 사용한 2가지 유형이 있음
* EBS 볼륨 기능
    - 모든 EBS 볼륨은 스냅샷을 통해 복사할 수 있고, 기존 스냅샷을 다른 인스턴스에 공유해서 연결 가능, AMI로 등록 가능한 이미지로 변경 가능
    - 실행중인 인스턴스에 연결된 EBS볼륨에서도 직접 AMI 이미지를 생성 가능하지만, 데이터 손실을 방지하기 위해 운영체제를 종료하고 생성하는거를 권장
    - EBS 볼륨을 암호화해서 EC2 인스턴스가 저장하거나 송수신하는 데이터를 보호 가능. EBS에서는 내부에서 암호화 키를 자동으로 관리하거나, AWS KMS에서 제공되는 키를 사용 가능


### 인스턴스 스토어 볼륨

* 인스턴스 스토어 볼륨은 EBS 볼륨과 다른 임시 디스크
* 디스크가 연결된 인스턴스가 종료됐을 때 저장된 데이터는 영구히 삭제
* EBS대신 인스턴스 스토어 볼륨을 사용하는 이유
    - 인스턴스를 호스팅하고 있는 서버에 물리적 고속 NVMe 인터페이스로 연결된 SSD
    - 인스턴스 스토어 볼륨 요금은 인스턴스 요금에 포함돼 있다
    - 단기 역할 수행(Auto Scaling 그룸의 일부로 잠시 생성되는 인스턴스 등)이나 외부에서 데이터를 가져와서 처리 후 폐기하는 배포 모델에 적합
* 인스턴스 스토어 볼륨을 사용할 수있는 인스턴스 유형은 따로 있으므로 배포할 때 염두 필요



## 2-3 EC2 인스턴스 액세스

* 모든 인스턴스에는 기본적으로 최소 한 개의 프라이빗 IPv4 주소가 할당 

	프라이빗 네트워크에 사용되는 세 가지 IP 주소 범위  
처음 주소 ~  	마지막 주소  
10.0.0.0 ~ 	10.255.255.255  
172.16.0.0 ~  	172.31.255.255  
192.168.0.0 ~  	192.168.255.255  

* 프라이빗 서브넷에서 만들어진 인스턴스는 서브넷 내부에서만 통신 가능, 인터넷에는 직접 연결 불가능
* 인스턴스에 여러 개의 네트워크 인터페이스가 있어야 하는 경우, 하나 이상의 가상 탄력적 네트워크 인터페이스를 만들어 인스턴스에 연결
* 인터페이스는 기존 서브넷과 보안 그룹에 연결돼 있어야 함
* 인터페이스에 서브넷 범위 내의 정적 IP나 퍼블릭 IP를 할당 가능



## 2-4 EC2 인스턴스 보안

EC2 인스턴스가 무단으로 사용되지 않도록, 보안그룹, IAM역할, NAT (Network Address Translation)인스턴스, 키 페어 등의 도구를 지원

### 보안 그룹

* 방화벽 역할
* 기본 설정은 수신하는 모든 트래픽을 거부
* 지정한 트래픽 유형만 허용하는 정책 규칙 설정
* 원본과 대상, 대상 네트워크 포트, 사용 프로토콜을 검사해서 트래픽을 평가
* 정교하게 액세스 관리가 가능하므로, 인터넷에 공개하더라도 백엔드 서버에는 팀원만 액세스 하도록 가능
* 인스턴스 수준에서 트래픽을 제어 (서브넷 수준의 트래픽 제어는 NACL을 사용)


### IAM 역할

* EC2 인스턴스를 비롯한 AWS 리소스에 액세스하는 것을 제어
* IAM 역할은 AWS 계정 내의 특정 서비스 또는 리소스에 작업을 수행할 수 있는 권한 부여
* 특정 사용자나 리소스에 역할을 할당하면 그 사용자나 리소스는 역할 정책에 포함된 다른 리소스에 액세스 가능


### NAT 디바이스

* EC2 인스턴스를 인터넷에 연결하지 않고 보안 패치와 소프트웨어 업데이트를 받기 위한 제한적인 인터넷 연결에 사용
* NAT 인스턴스와 NAT 게이트웨이를 사용해서 프라이빗 인스턴스에서 인터넷으로 향하는 트래픽을 라우팅 (매월 요금 청구)
* NAT 게이트웨이는 관리형 서비스이므로 직접 인스턴스를 시작하고 유지 관리할 필요 없음

￼


### 키 페어

* 세션 보호를 위해 키 페어를 생성해서 퍼블릭 키는 EC2 인스턴스에 저장, 다른 절반인 프라이빗 키는 사용자 단말에 저장
* AWS가 생성하는 키 페어는 생성한 리전 내에 설치 돼 있음
* 키 페어를 삭제할 때까지 새로 시작하는 인스턴스에 사용 가능
* 퍼블릭 키가 분실 혹은 노출됐다면 키를 반드시 삭제


## 2-5 기타 EC2 관련 서비스

### AWS System Manager

* AWS 콘솔로 사용 가능
* AWS 클라우드와 온프레미스 인프라에서 운영하는 리소스를 모니터링 및 관리를 위한 도구 모음
* AWS 리소스를 리소스 그룹으로 구성, 운영 상태와 동작을 마이닝, 패치 및 수명 주기 이벤트 자동화, 보안 액세스 관리 등의 작업 수행


### 배치 그룹

* 지연 시간이 짧은 네트워크 상호 연결이 필요한 여러 EC2 인스턴스에 유용 (두 가지 전략)
    - 클러스터 그룹은 단일 가용 영역 안에서 물리적으로 근접하고 서로 연결된 인스턴스를 시작
    - 분산형 그룹은 장애 관련 데이터나 서비스 손실 위헙을 줄이기 위해 물리적으로 분리된 하드웨어에 인스턴스를 분산


### AWS Elastic Beanstalk

* 사용자가 몇몇 파라미터를 정의하고 애플리케이션 코드를 올리면 AWS는 애플리케이션 실행에 필요한 인프라를 구성, 실행 유지
* EC2 로드 밸런싱, Auto Scaling, RDS 데이터베이스 인스턴스, 전체 네트워크 배치 등이 포함 (Beanstalk을 사용하지 않으면 사용자 직접 설치)
* 인프라 비용 외 추가 비용 없음


### AWS Elastic Container Service(ECS)와 AWS Fargate

* ECS를 사용하면 미리 구축된 Docker 호스트 인스턴스를 시작하고 Docker 컨테이너가 작업하는 방법을 정의 가능
* ECS로 컨테이너를 자동화하고 리소스와 완벽하게 통합되 인프라에서 운영 가능
* Fargate 도구는 ECS 구성 프로세스를 더욱 추상화
* Fargate를 사용하면 사용자는 컨테이너 인스턴스를 실행하고 구성할 필요 없으며, 애플리케이션 패키징과 환경 요구 사항 설정만 수행


### AWS Lambda

* 서버리스, 애플리케이션은 프로그래밍 코드 기반으로 실행
* 서버를 가동하는 비용을 들이지 않고서도 항상 온디맨드로 모든 작업을 즉시 수행


### VM Import/Export

* 온프레미스 VMware 환경과 AWS 계정 간의 S3를 거쳐 가상 머신 이미지를 쉽게 이동 가능
* 간단하게 하이브리드 환경을 관리, 워크로드를 효율적으로 AWS 클라우드로 마이그레이션 가능


### Elastic Load Balancing (ELB)과 Auto Scaling

* ELB은 서버 리소스를 더욱 효율적으로 분산, 사용자 경험 향상
* Auto Scaling은 사전 설정된 성능 임계값에 반응해서 수요에 따라 EC2 인스턴스 수를 자동으로 늘리거나 줄임
* ELB와 Auto Scaling은 EC2 인프라와 밀접하게 통합돼 있으며, 간단하고 원활한 운영을 도움
