# 3장 Amazon Simple Storage Service와 Amazon Glacier Storage

* 백업 아카이브, 로그 파일, 재해 복구 이미지 유지 관리
* 분석을 위한 빅데이터 저장
* 정적 웹사이트 호스팅
* 팔요에 따라 AWS 내외부에서 실행되는 작업에 밀접하게 통합할 수 있는 저렴하고 안정적인 스토리지
* 운영 체제 볼륨과는 다름. 운영 체제 볼륨은 블록 스토리지에 저장돼 EC2를 구동, S3는 무제한 객체 스토리지 공간을 효과적으로 제공
    - 블록 스토리지 : 물리적 디스크를 개별 블록으로 나눠 데이터를 저장하고 파일 시스템으로 관리
    - 객체 스토리지 : 구조화되지 않는 평면 저장소에 데이터를 저장
* S3에 파일을 쓸 때 최대 2KB 메타 데이터가 함께 저장. 메타 데이터는 데이터 사용 권한과 파일 시스템처럼 보이는 중첩 버킷 내 위치 정보 같은 시스템 세부 정보를 구성하는 키로 만들어짐

## 3-1 S3 서비스 아키텍처

* S3 파일은 버킷(데이터를 나누는 구간)으로 구성. 게정당 기본으로 만들 수 있는 버킷은 100개(할당량 증가 요청 필요)
* S3 버킷과 그 내용은 한 AWS 리전에만 존재, 버킷 주소는 전체 S3 글로벌 시스템 내에서 유일

### 접두사와 구분 기호

* S3 버킷은 하위 폴더 구조가 없는 평면 구조이며, 객체는 이 버킷에 저장
* 접두사와 구분 기호를 사용해서 버킷을 조금 더 체계적인 모습으로 내타낼 수 있음
* 일반 텍스트 문자열을 접두사로 사용해서 구조화된 수준을 표현
    - Ex) contract/acme.pdf, contract/dynamic.pdf 처럼 /기호로 pdf파일을 S3 버킷 내 그룹 contract 안에 있는 파일처럼 보이게 한다

### 대용량 객체 작업

* 이론적으로 버킷에 무한대 용량의 데이터를 저장 가능. 단일 객체 크기는 5TB 이하, 한 번에 업로드할 수 있는 용량 크기는 최대 5GB
* 100MB가 넘는 객체는 멀티 파트 업로드를 사용해서 데이터의 손실이나 중지 위험을 줄이는 것을 권장
* 멀티 파트 업로드는 큰 객체를 여러 작은 부분으로 나눠서 S3 대상 위치에 하나씩 전송. 전송에 실패하면 그 부분만 다시 전송
* AWS CLI나 상위 수준 API에서는 멀티 파트 업로드가 자동으로 실행

### 암호화

* 웹사이트 같이 퍼블릭 액세스가 아니라면 S3의 데이터는 항상 암호화 필요
* 저장 중인 데이터 보호를 위해 암호화 키를 사용하거나, 전송 데이터를 보호하기 위해 Amazon 암호화 API 엔드포인트 사용. 

* 서버 측 암호화
    - 서버 측은 S3 플랫폼을 의미
    - 데이터 객체를 암호화해서 디스크에 저장하는 작업
    - 데이터를 가져올 때 적합한 인증으로 복호화하는 작업
    - 세가지의 암호화 방법이 존재
        1. S3가 관리하는 암호화 키(SSE-S3)를 사용하면 AWS가 자체 엔터프라이즈 표준 키를 사용해 암호화와 복호화 프로세스의 모든 단계를 관리
        2. AWS KMS-관리형 키를 사용하는 서버 측 암호화(SSE-KMS)를 사용하면 SSE-S3의 기능에 더해 완벽한 키 사용 추적 및 봉투 키 사용 가능
        3. 고객 제공 암호화 키에 의한 서버 측 암호화(SSE-C)는 고객이 S3에 제공한 자체 키로 객체를 암호화

* 클라이언트 측 암호화
    - S3로 데이터를 전송하기 전에 암호화
    - AWS KMS-관리형 고객 마스터 키(KMS-CMK)를 사용, 업로드 전에 고유 키로 객체를 암호화
    - S3 암호화 클라이언트에서 제공된 클라이언트 측 마스터 키를 사용 가능
    - 암호화 절차를 단순화 하기 때문에 서버 측 암호화를 주로 사용. 조직의 규정 법규의 제함으로 암호화의 모든 권한을 가지고 있어야 하는 경우 클라이언트 측 암호화 사용

### 로깅

* S3 이벤트 추적을 로그 파일에 저장하는 기능은 디폴트가 비활성화
* 원본 버킷(활동을 추적할 버킷)과 대상 버킷(로그를 저장할 버킷)을 지정. 여러 원본 버킷 로그 식별을 위해 구분 기호와 접두사 사용
* S3 생성 로그는 구성하면 다음과 같은 작업 상세 항목이 기본으로 나타남
    - 요청자 계정과 IP 주소
    - 원본 버킷 이름
    - 요청 동작 (GET, PUT 등)
    - 요청 개시 시간
    - 응답 상태(오류 코드 포함)
* S3 버킷은 Cloud Watch나 Cloud Trail 같은 다른 서비스가 로그 또는 다른 객체(EBS 스냅샷 등)를 저장하는데도 사용


## 3-2 내구성과 가용성

객체를 저장할 때 S3 스토리지 클래스 중에서 내구성, 가용성, 지축 가능 비용에 따라 선택 가능

### 내구성

* 대부분의 S3 클래스와 Amazon Glacier는 99.999999999%의 내구성의 보장
* 잘못된 구성, 계정 잠김, 예기치 않은 외부 공격 등으로 데이터에 액세스 못 할 경우를 대비해 한 버킷에만 저장하는 것은 권장하지 않음
* S3는 최소 3개의 가용 영역에 데이터를 자동으로 복제하기 때문에 높은 내구성을 보장
* 복원력이 전혀 없는 스토리지 클래스도 존재. 내구성 증감, 가용성, 비용등을 고려해 선택
    - Amazon S3 One Zone-IA(Infra Access) : 데이터를 단일 가용 영역에 저장
    - RRS (Reduced Redundancy Storage) : 다른 클래스보다 더 적은 영역에 복제. 99.99%의 내구성 보장

	S3 Standard	S3 Standard-IA	S3 One Zone-IA	Reduced Redundancy


### 가용성

* 객체 가용성은 1년 동안 해당 객체를 요청했을 때 즉시 응답할 수 있는 기간을 백분율로 나타냄
* 99.99%는 중단 시간이 99.99% 기간 동안 1시간 이내라는 의미

### 데이터 최종 일관성

* S3는 데이터를 여러 장소에 복제하므로, 기존 데이터가 업데이트 되면 시스템에 전파하는 동안에 약간의 지연 발생
* 단일 객체의 버전 여러 개가 충돌하면 애플리케이션과 데이터 사이에 심각한 손상이 발생 가능성이 존재
* 최종 일관성 표준에 따라 데이터 처리를 설계해야 하며, 보통 2초 이하의 지연 시간을 고려


## 3-3 S3 객체 수명 주기

* 정기적으로 수행되는 백업으로 백업 아카이브가 증가될 수 있음
* S3 버전 관리와 수명 주기 기능으로 모든 작업을 자동화 하여, 오래된 버전을 삭제해서 스토리지 비용을 절약 가능

### 버전 관리

* 버킷 수준에서 버전 관리를 활성화하면 덮어쓴 이전 객체를 보존할 수 있어서 기존 버전에 계속 액세스 할 수 있음
* 실수로 기존 데이터를 잃게 되는 문제를 해결할 수 있지만 아카이브가 늘어나는 것은 감수 필요

### 수명 주기 관리

* 버킷에서 수명 주기 규칙을 구성하면 지정한 기간이 경과했을 때 자동으로 객체가 다른 스토리지 클래스로 옮겨짐
    - Ex) 첫 30일 동안 S3 Standard 클래스에 보관, 이후 더 저렴한 One Zone-IA로 옮겨짐
* 과거 버전을 유지해야하는 조직의 규정이 있다면, 파일을 저렴한 장기 저장용 스토리지인 Glacier로 옮겨서 365일간 보관, 이후 영구 삭제
* 접두사를 사용해 버킷 내 특정 객체에만 수명 주기 규칙을 적용 가능
* 한 클래스에서 보관해야하는 최소 시간을 지정 필요
* S3 Standard 클래스에서 Reduced Redundancy로 바로 전환은 불가


## 3-4 객체 액세스

데이터의 중요성에 맞게 S3에 저장된 객체에 액세스하는 방법과 업무의 보안상 필요에 맞는 요청만 액세스하도록 제한하는 방법 이해 필요

### 액세스 제어

* 새롭게 S3 버킷과 객체를 생성한 즉시, 사용자 계정에서는 액세스 가능하지만, 다른 계정이나 외부에서는 액세스 불가능
* 액세스 제어 목록(ACL) 규칙, 세분화된 S3 버킷 정책, IAM 정책을 사용해서 버킷이나 객체 수준에서 타 계정이나 외부 사용자에게 액세스 허용 가능
* 현재는 ACL 대신 S3 버킷 정책이나 IAM 정책을 적용할 것을 권장
* S3 버킷 정책 (json 텍스트 형식으로 S3 버킷에 연결) 은 외부 계정과 사용자가 S3 버킷에 액세스하는 것을 제어
* IAM 정책은 IAM이 관리하는 계정 즉, 사용자와 역할이 S3를 비롯한 여러 리소스에 액세스하는 방식을 제어하고자 할 때 사용
* 날짜, 시간, 원본 CIDR IP 주소 블록을 버킷 정책에 지정해서 제한 가능


### 미리 서명된 URL

* 외부 액세스가 제한된 프라이빗 객체에 임시로 액세스할 수 있게 할 때, 미리 서명된 URL을 사용 가능
* 미리 서명된 URL은 지정한 기간만 사용 가능 (기본 만료 값은 1시간)
* 프로그래밍 방식으로 객체에 액세스할 수 있도록 미리 서명된 URL을 생성하는 명령을 코드에 포함해서 빌드 가능
* 미리 서명된 URL을 생성하는 AWS CLI 명령으로도 가능(하기 예시는 600초)
    - AWS s3 presing s3://MyBucketName/PrivateObject --expires-in 600

### 정적 웹사이트 호스팅

* S3 버킷은 정적 웹사이트 HTML 파일 호스팅하는 데 저렴하고 안정된 플랫폼으로 사용 가능
* S3 버킷을 정적 호스팅으로 구성하면, 버킷 URL 트래픽이 자동으로 지정된 루트 문서로 연결
* DNS 도메인 이름을 정적 사이트로 라우팅하려면, Amazon Route53에서 버킷 엔드포인트를 도메인 이름과 연결

### S3 Select와 Glacier Select

* Select는 AWS에서 제공하는 S3나 Glacier에 저장한 데이터에 액세스할 수 있는 또 다른 방법
* SQL과 유사한 쿼리로 저장된 객체에서 관련 데이터만 검색 가능 (효율적이고 저렴한 작업 가능)


## 3-5 Amazon Glacier

* Glacier는 S3 스토리지 클래스의 일부로 사용자에게 보여짐
* Glacier는 99.999999999%의 내구성을 보장
* S3 수명 주기에 통합 가능
* S3와 달리 Glacier는 단일 객체 최대 크기가 40TB(S3는 5TB)로 대형 아카이브를 지원
* Glacier 아카이브는 암호화가 기본 (S3는 선택)
* S3는 인간이 읽을 수 있는 이름으로 키를 만들지만, Glacier 아카이브에는 기계가 만든 ID가 주어짐
* 데이터를 가져오는데 S3는 즉시 액세스 가능, Glacier는 몇 시간이 걸릴 수 있음
    - Glacier는 데이터의 필요성과 사용 빈도가 낮은 환경에서 장기적으로 데이터를 보관할 수 있는 저렴한 스토리지가 목적이기 때문
* Glacier에서 몇 분만에 데이터를 가져오게 하려면 프리미엄 요금 필요


## 3-6 스토리지 요금

* 스토리지 용량 요금은 전체 요금을 구성하는 한 부분일 뿐임
* 데이터를 가져오는 작업(PUT, COPY, POST, LIST 요청)과 수명 주기 전혼 등에도 요금이 청구


## 3-7 기타 스토리지 관련 서비스

### Amazon Elastic File System (EFS)

* 자동 확장 가능한 공유 파일 스토리지
* VPC내에서 Network File System(NFS)으로 여러 EC2 인스턴스에 정착하거나, AWS Direct Connect 연결로 온프레미스 서버에서 액세스할 수 있도록 설계
* EFS는 여러 인스턴스가 짧은 지연 시간으로 안전하고 내구성 있게 파일을 공유하는데 사용

### AWS Storage Gateway

* 온프레미스의 로컬 백업과 아카이브 운영 요구 사항을 클라우드 스토리지 서비스를 사용해 해결하기 위한 구성을 간편하게 가능
* AWS Storage Gateway를 사용해 소프트웨어 방식의 게이트웨이 어플라이언스(VMware ESXi, EC2)로 다양한 가상 연결 인터페이스를 구현
* 물리적 백업 장치를 연결하는 것처럼 어플라이언스를 로컬 장치에 연결하면 데이터를 S3나 EBS와 같은 AWS플랫폼에 저장 가능

### AWS Snowball

* 대용량 데이터 세트를 일반 인터넷 연결로 클라우드에 마이그레이션에 필요한 많은 시간과 대역폭을 가능하게 하는 장치
* 테라바이트 또는 페타바이트 크기 데이터를 백업 또는 실제 사용을 위해 AWS로 이동할 때 사용
* 사용자가 요청하면 AWS는 256비트로 암호화한 물리적 Snowball 저장 장치를 사용자에세 배송
* 사용자가 데이터를 Snowball에 복사한 다음 장치를 돌려보내면 Amazon 은 그 데이터를 S3버킷에 업로드
 